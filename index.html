<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Narratoscope • Editorial Computer</title>
  <style>
    /* Пиксельные шрифты (офлайн). Положи файлы в assets/fonts/ */
    @font-face{font-family:'Pixel UI';src:url('assets/fonts/PixelOperator.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
    @font-face{font-family:'Pixel UI';src:url('assets/fonts/PixelOperator-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap}
    /* Доп. пиксельный шрифт с кириллицей */
    @font-face{font-family:'FSEX';src:url('assets/fonts/FSEX300.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
    /* ╔══════════════════════════════════════════════════════════════════════╗
       ║  CORE UI СТИЛИ: ВИНТАЖНЫЙ РАБОЧИЙ СТОЛ (Windows-95 вайб)            ║
       ║  Всё, что ниже, — ядро. Модули имеют собственные блоки CSS/JS.      ║
       ╚══════════════════════════════════════════════════════════════════════╝ */

    :root {
      --bg-paper: #F4F1EC;      /* warm off-white, Xerox Star style */
      --panel: #faf8f5;         /* базовый цвет панелей */
      --panel-dark: #000;
      --panel-light: #fff;
      --text: #000;
      --accent: #000;
      --accent-2: #000;
      --icon-size: 180px;
      --window-min-w: 360px;
      --window-min-h: 220px;
      --taskbar-h: 36px;
      --z-window: 10; --z-menu: 30; --z-boot: 1000; --z-password: 1001;

      --ui-font: 'FSEX','Pixel UI','Press Start 2P', ui-monospace, "Courier New", monospace;
      --ui-font-size: 20px; /* базовый размер в окнах */
      --font-ui: 20px;           /* = --ui-font-size (для удобства) */
      --font-title: 16px;        /* заголовки окон */
      --font-icon: 26px;         /* подписи под иконками на рабочем столе */
      --font-controls: 16px;     /* кнопки/inputs внутри окон */
      --ui-line: 1.3;
    }

    html, body { height: 100%; }
    body {
      margin: 0; overflow: hidden; height: 100dvh; width: 100vw;
      background-color: var(--bg-paper);
      /* Xerox Star rectangular dithering: staggered pattern - 4px × 12px pattern unit, 1px × 3px vertical rectangles */
      background-image: url('data:image/svg+xml;utf8,<svg width="4" height="12" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="1" height="3" fill="%23000"/><rect x="2" y="7" width="1" height="3" fill="%23000"/></svg>');
      background-size: 4px 12px;
      background-position: 0 0;
      font-family: var(--ui-font); font-size: var(--font-ui); line-height: var(--ui-line);
      color: var(--text);
      image-rendering: pixelated; image-rendering: crisp-edges;
      /* ПИКСЕЛЬНЫЙ ЧЕРНЫЙ КУРСОР */
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M1 1 L1 13 L5 9 L9 13 L11 11 L7 7 L11 3 Z" fill="black" stroke="black" stroke-width="1"/></svg>') 1 1, default;
    }

    .desktop { position: relative; inset: 0; height: calc(100% - var(--taskbar-h)); width: 100%; padding: 12px; box-sizing: border-box; user-select: none; }

    /* ИКОНКИ */
    .icon { position: absolute; width: var(--icon-size); height: var(--icon-size); display: grid; align-content: center; justify-items: center; color: #000; text-align: center; font-size: 12px; transition: transform .05s linear; }
    .icon:active { transform: scale(0.98); }

    .glyph { width: 168px; height: 168px; position: relative; image-rendering: pixelated; background-size: cover; }
    /* Если подставляем PNG — полностью прозрачный фон, используем саму картинку */
    .glyph.has-image{ background-color: transparent; background-repeat: no-repeat; background-position: center; background-size: contain; }

    /* Подпись иконки — крупнее и ближе */
    .icon .label { margin-top: 2px; padding: 2px 6px; border: 1px dashed transparent; border-radius: 0; background: transparent; color: #000; text-shadow: none; line-height: 1.2; font-size: var(--font-icon); letter-spacing:.3px; }
    /* Выделение: инвертированные цвета */
    .icon.selected .label { background: #000; color: #fff; border-color: #000; }

    /* Контекстное меню */
    .context-menu { position: fixed; z-index: var(--z-menu); background: #fff; border: 2px solid #000; min-width: 180px; font-size: var(--font-controls); }
    .context-item { padding: 8px 12px; cursor: default; }
    .context-item:hover { background: #000; color:#fff; }
    .context-sep { height: 2px; background: #000; margin: 4px 0; }

    /* Окна */
    .window { position: absolute; top: 80px; left: 120px; min-width: var(--window-min-w); min-height: var(--window-min-h); background: #fff; border: 2px solid #000; display: grid; grid-template-rows: 26px 1fr; z-index: var(--z-window); }
    .titlebar { 
      position: relative;
      height: 26px; 
      background-color: var(--bg-paper);
      background-image: url('data:image/svg+xml;utf8,<svg width="2" height="2" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="1" height="1" fill="%23000"/><rect x="1" y="1" width="1" height="1" fill="%23000"/></svg>');
      background-size: 2px 2px;
      padding: 0 8px; 
      display: flex;
      align-items: center;
      justify-content: flex-end;
      user-select: none; 
      cursor: move; 
      border-bottom: 1px solid #000; 
    }
    .title-label {
      position: absolute;
      left: 8px;
      top: 3px;
      transform: none;
      background: #fff;
      padding: 1px 6px;
      border: 1px solid #000;
      display: inline-block;
      font-weight: 700;
      font-size: var(--font-title);
      letter-spacing: .4px;
      color: #000;
      white-space: nowrap;
      line-height: 1;
      -webkit-clip-path: polygon(4px 0, calc(100% - 4px) 0, calc(100% - 3px) 1px, calc(100% - 2px) 2px, calc(100% - 1px) 3px, 100% 4px, 100% calc(100% - 4px), calc(100% - 1px) calc(100% - 3px), calc(100% - 2px) calc(100% - 2px), calc(100% - 3px) calc(100% - 1px), calc(100% - 4px) 100%, 4px 100%, 3px calc(100% - 1px), 2px calc(100% - 2px), 1px calc(100% - 3px), 0 calc(100% - 4px), 0 4px, 1px 3px, 2px 2px, 3px 1px);
      clip-path: polygon(4px 0, calc(100% - 4px) 0, calc(100% - 3px) 1px, calc(100% - 2px) 2px, calc(100% - 1px) 3px, 100% 4px, 100% calc(100% - 4px), calc(100% - 1px) calc(100% - 3px), calc(100% - 2px) calc(100% - 2px), calc(100% - 3px) calc(100% - 1px), calc(100% - 4px) 100%, 4px 100%, 3px calc(100% - 1px), 2px calc(100% - 2px), 1px calc(100% - 3px), 0 calc(100% - 4px), 0 4px, 1px 3px, 2px 2px, 3px 1px);
    }
    .titlebar .buttons { display: flex; gap: 4px; }
    .titlebar button { height: 20px; width: 22px; border: 2px solid #000; background: #fff; cursor: pointer; image-rendering: pixelated; font-weight: 700; line-height: 1; display:flex; align-items:center; justify-content:center; padding:0; font-family: var(--ui-font); }
    .titlebar button:hover { background: #000; color: #fff; }
    .content { padding: 12px; background: #fff; color:#000; overflow: auto; }
    .resizer { position: absolute; right: 0; bottom: 0; width: 0; height: 0; border-left: 12px solid transparent; border-top: 12px solid transparent; border-right: 12px solid #000; border-bottom: 12px solid #000; cursor: nwse-resize; }

    /* Кнопки и формы внутри окон — ч/б пиксельный стиль */
    .content button,
    .content input[type="button"],
    .content input[type="submit"]{
      border:1px solid #000; background:#fff; padding:6px 10px; cursor:pointer;
      font-family:var(--ui-font); font-size: var(--font-controls); letter-spacing:.2px; image-rendering:pixelated;
    }
    .content button:hover,
    .content input[type="button"]:hover,
    .content input[type="submit"]:hover{ background:#000; color:#fff; }

    .content input[type="text"],
    .content textarea,
    .content select{
      border:1px solid #000; background:#fff; padding:6px; font-family:var(--ui-font);
      font-size: var(--font-controls); box-sizing:border-box;
      image-rendering: pixelated;
    }
    
    /* Internal UI lines - rasterized, pixel-constructed */
    .content hr {
      border: none;
      border-top: 1px solid #000;
      margin: 12px 0;
      height: 0;
    }
    .content table {
      border-collapse: separate;
      border-spacing: 0;
    }
    .content table td,
    .content table th {
      border: 1px solid #000;
    }
    .content textarea{ resize:vertical; }

    /* Статус отправки формы (пиксельный текст под кнопкой) */
    .form-status{ margin-top:8px; font-family: var(--ui-font); font-size: var(--font-controls); line-height:1.2; }
    .form-status.ok{ color:#067d00; }
    .form-status.err{ color:#9b0000; }

    /* Выравнивание символов в кнопках окна */
    .titlebar .buttons button:first-child { /* Свернуть — "—" */
      font-size: 14px; transform: translateY(-1px);
    }
    .titlebar .buttons button:last-child { /* Закрыть — "×" */
      font-size: 16px; transform: translateY(-1px);
    }

    /* Панель задач */
    .taskbar { 
      position: absolute; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      height: var(--taskbar-h); 
      background-color: var(--bg-paper); 
      background-image: url('data:image/svg+xml;utf8,<svg width="2" height="2" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="1" height="1" fill="%23000"/><rect x="1" y="1" width="1" height="1" fill="%23000"/></svg>');
      background-size: 2px 2px; 
      border-top: 1px solid #000; 
      display: grid; 
      grid-template-columns: 1fr auto; 
      align-items: center; 
      gap: 8px; 
      padding: 0 8px; 
      box-sizing: border-box; 
    }
    .tasks { display: flex; gap: 6px; align-items: center; overflow: auto; }
    .task-btn { 
      height: 26px; 
      padding: 0 10px; 
      border: 1px solid #000; 
      background-color: #FFFFFF;
      cursor: pointer; 
      white-space: nowrap;
    }
    .clock { padding: 0 10px; border: 1px solid #000; background: #fff; }

    .start-menu{ position:absolute; left:8px; bottom:calc(var(--taskbar-h) + 4px); width:360px; background:#fff; border:2px solid #000; z-index:var(--z-menu); display:grid; grid-template-rows:auto 1fr; }
    .start-head{ background:#fff; color:#000; font-weight:700; padding:8px; border-bottom:2px solid #000; font-size:var(--font-title); letter-spacing:.3px; }
    .start-body{ padding:12px; }
   
   /* Виджет-качалка */
    .rocker-widget{
      position:fixed; right:12px; bottom:calc(var(--taskbar-h) - 2px);
      width:160px; height:160px;
      background:transparent url('assets/ui/rocker-pixel.svg') center/contain no-repeat;
      image-rendering:pixelated; z-index:25; cursor:pointer;
      border:none; outline:none; box-shadow:none; padding:0;
      -webkit-appearance:none; appearance:none; background-color:transparent;
    }
    @keyframes rock{ 0%{ transform:rotate(-2deg);} 50%{transform:rotate(2deg);} 100%{transform:rotate(-2deg);} }
    .rocker-widget{ animation: rock 4s ease-in-out infinite; transform-origin: 50% 95%; }
    @keyframes rock{ 0%{ transform:rotate(-2deg);} 50%{transform:rotate(2deg);} 100%{transform:rotate(-2deg);} }
    .rocker-widget{ animation: rock 4s ease-in-out infinite; transform-origin: 50% 90%; }

    /* Экран ввода пароля */
    .password-screen { 
      position: fixed; 
      inset: 0; 
      background-color: var(--bg-paper); 
      background-image: url('data:image/svg+xml;utf8,<svg width="4" height="12" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="1" height="3" fill="%23000"/><rect x="2" y="7" width="1" height="3" fill="%23000"/></svg>');
      background-size: 4px 12px; 
      color: #000; 
      display: grid; 
      place-items: center; 
      z-index: var(--z-password); 
      font-family: var(--ui-font); 
      user-select: none; 
    }
    .password-box { background: #fff; border: 2px solid #000; padding: 24px 32px; text-align: center; }
    .password-box h2 { margin: 0 0 16px 0; font-size: 18px; font-weight: 700; }
    .password-box p { margin: 0 0 20px 0; font-size: 14px; }
    .password-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .password-inputs input { border: 2px solid #000; background: #fff; padding: 8px; font-family: var(--ui-font); font-size: 14px; text-transform: capitalize; text-align: center; }
    .password-inputs input:focus { outline: 2px solid #000; outline-offset: 2px; }
    .password-error { color: #9b0000; font-size: 12px; margin-top: 8px; min-height: 16px; }
    .password-box button { border: 2px solid #000; background: #fff; padding: 8px 16px; cursor: pointer; font-family: var(--ui-font); font-size: 14px; font-weight: 700; }
    .password-box button:hover { background: #000; color: #fff; }

    /* Загрузочный экран */
    .boot { 
      position: fixed; 
      inset: 0; 
      background-color: var(--bg-paper); 
      background-image: url('data:image/svg+xml;utf8,<svg width="4" height="12" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="1" height="3" fill="%23000"/><rect x="2" y="7" width="1" height="3" fill="%23000"/></svg>');
      background-size: 4px 12px; 
      color: #000; 
      display: grid; 
      place-items: center; 
      z-index: var(--z-boot); 
      font-family: var(--ui-font), "Courier New", ui-monospace, monospace; 
      user-select: none; 
    }
    .boot .box { text-align: center; }
    .boot .bar { width: min(60vw, 560px); height: 10px; border: 2px solid #000; margin-top: 12px; background: #fff; }
    .boot .bar > i { display: block; height: 100%; width: 0%; background: #000; }

    .hidden { display: none !important; }
    .noselect { user-select: none; }

  </style>
</head>
<body>
  <!-- Экран ввода пароля -->
  <div id="passwordScreen" class="password-screen">
    <div class="password-box">
      <h2>Access Required</h2>
      <p>Password required to access<br>Lida Petrova's editorial computer</p>
      <div class="password-inputs">
        <input type="text" id="pwd1" placeholder="Word 1" maxlength="20" autocomplete="off">
        <input type="text" id="pwd2" placeholder="Word 2" maxlength="20" autocomplete="off">
        <input type="text" id="pwd3" placeholder="Word 3" maxlength="20" autocomplete="off">
      </div>
      <button id="passwordSubmit">Enter</button>
      <div class="password-error" id="passwordError"></div>
    </div>
  </div>

  <!-- Рабочий стол и системные элементы -->
  <div id="desktop" class="desktop" aria-label="Narratoscope Desktop"></div>

  <div class="taskbar" role="toolbar">
    <div id="taskspace" class="tasks"></div>
    <div class="clock" id="clock">--:--</div>
  </div>

  <div id="ctx" class="context-menu hidden" role="menu"></div>

  <div id="boot" class="boot hidden">
    <div class="box">
      <div>Narratoscope Editorial OS</div>
      <div>© 2025 Narratoscope—editor workstation</div>
      <div class="bar"><i id="bootbar"></i></div>
    </div>
  </div>

  <div id="startMenu" class="start-menu hidden" role="menu" aria-label="Start menu">
    <div class="start-head">Narratoscope Editorial Computer</div>
    <div class="start-body">
      <p style="font-size: 14px; margin: 0;">User: Lida Petrova</p>
    </div>
  </div>

  <script>
    /* ╔══════════════════════════════════════════════════════════════════════╗
       ║                               CORE                                  ║
       ║  • Регистрация модулей • Рендер иконок • Drag&Drop • Контекстное     ║
       ║    меню • Окна (свернуть/закрыть/resize) • Часы • Таскбар‑кнопки    ║
       ╚══════════════════════════════════════════════════════════════════════╝ */

    /* ===== Обои рабочего стола =====
       Dithering паттерн уже применен в CSS body */
function applyWallpaper(){
      // Паттерн применяется через CSS, функция оставлена для совместимости
    }
    function nextWallpaper(){ 
      // Один паттерн, переключение не требуется
    }

const DesktopCore = (() => {
      const desktop = document.getElementById('desktop');
      const taskspace = document.getElementById('taskspace');
      const ctx = document.getElementById('ctx');
      const clock = document.getElementById('clock');

      const registry = new Map();         // id -> module API
      const iconState = new Map();        // id -> {x,y}
      const windows = new Map();          // winId -> {el, taskBtn, minimized}

      const uid = () => Math.random().toString(36).slice(2, 9);
      const bringToFront = (el) => {
        let maxZ = 10; document.querySelectorAll('.window').forEach(w => {
          const z = parseInt(getComputedStyle(w).zIndex || 10, 10); if (z > maxZ) maxZ = z; });
        el.style.zIndex = maxZ + 1; };

      /* Часы */
      const tickClock = () => { const n = new Date(); clock.textContent = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; };
      setInterval(tickClock, 1000); tickClock();


      /* Контекстное меню */
      let ctxTarget = null;
      const hideContext = () => { ctx.classList.add('hidden'); ctxTarget = null; };
      const showContext = (x, y, items, target=null) => {
        ctx.innerHTML = '';
        items.forEach(item => {
          if (item === 'sep') { const s = document.createElement('div'); s.className = 'context-sep'; ctx.appendChild(s); return; }
          const d = document.createElement('div'); d.className = 'context-item'; d.textContent = item.label;
          d.addEventListener('click', () => { item.action?.(target); hideContext(); }); ctx.appendChild(d);
        });
        const { innerWidth, innerHeight } = window;
        ctx.style.left = Math.min(x, innerWidth - 180) + 'px';
        ctx.style.top  = Math.min(y, innerHeight - 120) + 'px';
        ctx.classList.remove('hidden');
        ctxTarget = target;
      };
      document.addEventListener('click', (e) => { if (!ctx.contains(e.target)) hideContext(); });

      /* Таскбар-кнопки */
      const createTaskButton = (winEl, title) => {
        const b = document.createElement('button'); b.className = 'task-btn'; b.textContent = title;
        b.addEventListener('click', () => {
          const info = windows.get(winEl.dataset.winId); if (!info) return;
          if (info.minimized) { info.el.classList.remove('hidden'); info.minimized = false; bringToFront(info.el); }
          else { bringToFront(info.el); }
        }); taskspace.appendChild(b); return b; };

      /* Окна */
      const createWindow = ({ title = 'Окно', content, width = 760, height = 520 }={}) => {
        const w = document.createElement('div'); w.className = 'window';
        w.style.width = width + 'px'; w.style.height = height + 'px'; w.dataset.winId = uid();

        // Центрируем новое окно на рабочем столе
        const dRect = desktop.getBoundingClientRect();
        const left = Math.max(12, Math.round((dRect.width  - width)  / 2));
        const top  = Math.max(12, Math.round((dRect.height - height) / 2));
        w.style.left = left + 'px';
        w.style.top  = top  + 'px';

        const tb = document.createElement('div'); tb.className = 'titlebar';
        const titleLabel = document.createElement('div'); titleLabel.className = 'title-label'; titleLabel.textContent = title;
        tb.appendChild(titleLabel);
        const btns = document.createElement('div'); btns.className = 'buttons';
        const min = document.createElement('button'); min.title = 'Свернуть'; min.textContent = '—';
        const close = document.createElement('button'); close.title = 'Закрыть'; close.textContent = '×';
        btns.appendChild(min); btns.appendChild(close); tb.appendChild(btns); w.appendChild(tb);

        const cont = document.createElement('div'); cont.className = 'content';
        if (typeof content === 'string') cont.innerHTML = content; else if (content instanceof Node) cont.appendChild(content);
        w.appendChild(cont);

        const rz = document.createElement('div'); rz.className = 'resizer'; w.appendChild(rz);

        /* Перетаскивание */
        let ox=0, oy=0, dragging=false;
        tb.addEventListener('mousedown', (e) => { dragging = true; bringToFront(w); const r = w.getBoundingClientRect(); ox = e.clientX - r.left; oy = e.clientY - r.top; document.body.classList.add('noselect'); });
        window.addEventListener('mousemove', (e) => { if (!dragging) return; w.style.left = (e.clientX - ox) + 'px'; w.style.top = (e.clientY - oy) + 'px'; });
        window.addEventListener('mouseup', () => { dragging = false; document.body.classList.remove('noselect'); });

        /* Resize */
        let resizing=false, rx=0, ry=0, startW=0, startH=0;
        rz.addEventListener('mousedown', (e)=>{ resizing = true; bringToFront(w); rx = e.clientX; ry = e.clientY; const r = w.getBoundingClientRect(); startW = r.width; startH = r.height; document.body.classList.add('noselect'); });
        window.addEventListener('mousemove', (e)=>{ if (!resizing) return; const root = getComputedStyle(document.documentElement); const minW = parseInt(root.getPropertyValue('--window-min-w')); const minH = parseInt(root.getPropertyValue('--window-min-h')); const nw = Math.max(startW + (e.clientX - rx), minW); const nh = Math.max(startH + (e.clientY - ry), minH); w.style.width = nw + 'px'; w.style.height = nh + 'px'; });
        window.addEventListener('mouseup', ()=>{ resizing=false; document.body.classList.remove('noselect'); });

        /* Кнопки */
        const taskBtn = createTaskButton(w, title);
        min.addEventListener('click', () => { w.classList.add('hidden'); const info = windows.get(w.dataset.winId); if (info) info.minimized = true; });
        close.addEventListener('click', () => { const id = w.dataset.winId; const info = windows.get(id); info?.taskBtn?.remove(); windows.delete(id); w.remove(); });

        w.addEventListener('mousedown', () => bringToFront(w));
        desktop.appendChild(w); bringToFront(w);
        windows.set(w.dataset.winId, { el: w, taskBtn, minimized: false });
        return w;
      };

      /* Иконки */
      const createIcon = ({ id, title, className='', iconUrl, x=20, y=20, onOpen, contextItems }) => {
        const el = document.createElement('div'); el.className = 'icon'; el.style.left = x + 'px'; el.style.top = y + 'px'; el.dataset.id = id;
        const g = document.createElement('div'); g.className = 'glyph ' + className; if (iconUrl) { g.classList.add('has-image'); g.style.backgroundImage = `url('${iconUrl}')`; } el.appendChild(g);
        const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = title; el.appendChild(lab);

        el.addEventListener('click', () => { document.querySelectorAll('.icon').forEach(i => i.classList.remove('selected')); el.classList.add('selected'); });

        let lastClick = 0; el.addEventListener('mouseup', () => { const now = Date.now(); if (now - lastClick < 300) { onOpen?.(); } lastClick = now; });

        /* Drag&Drop */
        let dragging=false, dx=0, dy=0;
        el.addEventListener('mousedown', (e) => { if (e.button !== 0) return; dragging = true; dx = e.clientX - el.offsetLeft; dy = e.clientY - el.offsetTop; });
        window.addEventListener('mousemove', (e) => { if (!dragging) return; el.style.left = (e.clientX - dx) + 'px'; el.style.top = (e.clientY - dy) + 'px'; });
        window.addEventListener('mouseup', () => { if (!dragging) return; dragging = false; iconState.set(id, { x: el.offsetLeft, y: el.offsetTop }); });

        el.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); const items = contextItems ? contextItems() : defaultIconMenu(onOpen); showContext(e.clientX, e.clientY, items, el); });

        desktop.appendChild(el); return el; };

      const defaultIconMenu = (onOpen) => ([ { label: 'Открыть', action: () => onOpen?.() }, { label: 'Печать…', action: () => window.print() }, { label: 'Поделиться…', action: async () => { try { await navigator.share?.({ title: 'Bookflix', url: location.href }) } catch {} } }, ]);

      /* ===== Обои ===== */
      /* ПКМ по рабочему столу: обновить */
      desktop.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContext(e.clientX, e.clientY, [
          { label: 'Обновить', action: () => location.reload() },
        ]);
      });

      /* API ядра */
      function openModule(id){ const mod = registry.get(id); mod?.onOpen?.(); }
      return { register(def) { if (!def?.id) throw new Error('Модуль без id!'); registry.set(def.id, def); }, spawnWindow: createWindow, spawnIcon(def) { return createIcon(def); }, getIconPosition(id, fb) { return iconState.get(id) || fb; }, showContext, hideContext, get registry() { return registry; }, openModule };
    })();

    /* ╔══════════════════════════════════════════════════════════════════════╗
       ║                         МОДУЛИ (plug‑and‑play)                       ║
       ╚══════════════════════════════════════════════════════════════════════╝ */

    /* МОДУЛЬ: My Computer */
    DesktopCore.register({ id: 'my-computer', title: 'My Computer', iconClass: '', iconUrl: 'assets/icons/my-computer.png',
      onOpen() {
        const content = `<div style="font-family: var(--ui-font); font-size: 14px; line-height: 1.6;">
          <p><b>System:</b> Narratoscope Editorial OS</p>
          <p><b>User:</b> Lida Petrova</p>
          <br>
          <p><b>Free disk space:</b> 312 MB</p>
          <p><b>Last backup:</b> unknown</p>
          <br>
          <p><b>Note to self:</b></p>
          <p style="margin-left: 20px; font-style: italic;">(empty)</p>
        </div>`;
        DesktopCore.spawnWindow({ title: 'My Computer', width: 500, height: 380, content: content });
      }
    });

    /* МОДУЛЬ: Drafts (папка с текстовыми файлами) */
    DesktopCore.register({ id: 'drafts', title: 'Drafts', iconClass: '', iconUrl: 'assets/icons/notes.png',
  onOpen() {
    const wrap = document.createElement('div');
    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(auto-fill, 120px)';
    grid.style.gap = '16px';

        const draftsFiles = [
          {
            name: 'editorial_intro_draft.txt',
            content: `We keep pretending this is just a magazine.
It isn't.

It's a device.

Every issue slightly alters the way readers look at things.
Sometimes I worry that one day it will start looking back.`
          },
          {
            name: 'things_we_cut.txt',
            content: `— a whole section about mirrors
— the dream with the corridor and the child
— the paragraph where the Narratoscope hums

(Rodion said: "too much".
He's probably right.)`
          },
          {
            name: 'margin_notes_loose.txt',
            content: `"Reader is not passive."

"Reader is not innocent."

"Reader is the instrument."`
          }
        ];

        draftsFiles.forEach(file => {
        const cell = document.createElement('div');
        cell.style.width = '120px';
        cell.style.textAlign = 'center';
        cell.style.userSelect = 'none';
          cell.style.cursor = 'pointer';

        const ico = document.createElement('div');
        ico.style.width = '96px';
        ico.style.height = '96px';
        ico.style.margin = '0 auto';
          ico.style.backgroundImage = `url('assets/icons/txt.png')`;
        ico.style.backgroundRepeat = 'no-repeat';
        ico.style.backgroundPosition = 'center';
        ico.style.backgroundSize = 'contain';
        ico.style.imageRendering = 'pixelated';

        const cap = document.createElement('div');
          cap.textContent = file.name;
        cap.style.marginTop = '6px';
          cap.style.fontSize = '12px';

          cell.addEventListener('dblclick', () => {
            DesktopCore.spawnWindow({
              title: file.name,
              width: 640,
              height: 460,
              content: `<pre style="white-space: pre-wrap; font-family: var(--ui-font); font-size: 14px; line-height: 1.6;">${file.content}</pre>`
            });
          });

        cell.appendChild(ico);
        cell.appendChild(cap);
        grid.appendChild(cell);
      });

    wrap.appendChild(grid);
        DesktopCore.spawnWindow({ title: 'Drafts', width: 520, height: 420, content: wrap });
      }
    });

    /* МОДУЛЬ: Expenses.xlsx */
    DesktopCore.register({ id: 'expenses', title: 'Expenses.xlsx', iconClass: '', iconUrl: 'assets/icons/price.png',
    onOpen() {
        const content = `<div style="font-family: var(--ui-font); font-size: 14px;">
          <table border="1" cellspacing="0" cellpadding="8" style="width: 100%; border-collapse: separate; border-spacing: 0; background: #fff;">
            <tr style="background: #e0e0e0; font-weight: 700;">
              <th style="text-align: left; border: 1px solid #000;">Item</th>
              <th style="text-align: left; border: 1px solid #000;">Cost</th>
              <th style="text-align: left; border: 1px solid #000;">Notes</th>
            </tr>
            <tr>
              <td style="border: 1px solid #000;">Printing (test run)</td>
              <td style="border: 1px solid #000;">$420</td>
              <td style="border: 1px solid #000;">cheaper paper</td>
            </tr>
            <tr>
              <td style="border: 1px solid #000;">Hosting</td>
              <td style="border: 1px solid #000;">$12/month</td>
              <td style="border: 1px solid #000;">temporary</td>
            </tr>
            <tr>
              <td style="border: 1px solid #000;">Illustrator advance</td>
              <td style="border: 1px solid #000;">$150</td>
              <td style="border: 1px solid #000;">owes us favours</td>
            </tr>
            <tr>
              <td style="border: 1px solid #000;">Coffee</td>
              <td style="border: 1px solid #000;">$67</td>
              <td style="border: 1px solid #000;">non-negotiable</td>
            </tr>
            <tr>
              <td style="border: 1px solid #000;">Emergency fund</td>
              <td style="border: 1px solid #000;">$0</td>
              <td style="border: 1px solid #000;"></td>
            </tr>
          </table>
          <p style="margin-top: 16px; font-style: italic;">We are absolutely not ready.<br>Proceeding anyway.</p>
        </div>`;
        DesktopCore.spawnWindow({ title: 'Expenses.xlsx', width: 600, height: 400, content: content });
      }
    });

    /* МОДУЛЬ: Inbox */
    DesktopCore.register({ id: 'inbox', title: 'Inbox', iconClass: '', iconUrl: 'assets/icons/contacts.png',
      onOpen() {
        const emails = [
          {
            from: 'Rodion',
            subject: 'This might be stupid (or perfect)',
            content: `Lida,

I keep thinking about what you said — about readers being lenses.

What if we actually lean into it?
Not explain it.
Not defend it.

Let people feel it.

If you're still interested in collaborating — I'm in.

R.`
          },
          {
            from: 'printing@localpress',
            subject: 'About payment',
            content: `Hello,

Just checking if the invoice has been approved.

Please confirm.

(No reply.)`
          },
          {
            from: 'unknown',
            subject: 'I think something is happening',
            content: `I don't know who else to write to.

After reading the issue, I noticed I started remembering things
that weren't mine.

This is probably nothing.
Sorry.`
          },
          {
            from: 'Draft (unsent)',
            subject: '',
            content: `Dear —

If you're reading this,
then it worked.

Or it didn't, and I'm overthinking again.`
          }
        ];

        const wrap = document.createElement('div');
        wrap.style.fontFamily = 'var(--ui-font)';
        wrap.style.fontSize = '14px';

        emails.forEach((email, idx) => {
          const emailDiv = document.createElement('div');
          emailDiv.style.marginBottom = '20px';
          emailDiv.style.padding = '12px';
          emailDiv.style.border = '1px solid #000';
          emailDiv.style.cursor = 'pointer';
          emailDiv.style.backgroundColor = '#fff';

          emailDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 4px;">✉ Email ${idx + 1}</div>
            <div><b>From:</b> ${email.from}</div>
            <div><b>Subject:</b> ${email.subject}</div>
          `;

          emailDiv.addEventListener('click', () => {
            DesktopCore.spawnWindow({
              title: email.subject || 'Untitled',
              width: 600,
              height: 480,
              content: `<div style="font-family: var(--ui-font); font-size: 14px; line-height: 1.6;">
                <p><b>From:</b> ${email.from}</p>
                <p><b>Subject:</b> ${email.subject || '(no subject)'}</p>
                <hr style="border: 1px solid #000; margin: 12px 0;">
                <pre style="white-space: pre-wrap; font-family: var(--ui-font);">${email.content}</pre>
              </div>`
            });
          });

          wrap.appendChild(emailDiv);
        });

        DesktopCore.spawnWindow({ title: 'Inbox', width: 500, height: 520, content: wrap });
      }
    });

    /* МОДУЛЬ: Photos */
    DesktopCore.register({ id: 'photos', title: 'Photos', iconClass: '', iconUrl: 'assets/icons/journal.png',
      onOpen() {
        const photos = [
          'office_night.jpg',
          'coffee_spill.jpg',
          'window_reflection.jpg'
        ];

        const wrap = document.createElement('div');
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(auto-fill, 140px)';
        grid.style.gap = '20px';

        photos.forEach(photoName => {
          const cell = document.createElement('div');
          cell.style.width = '140px';
          cell.style.textAlign = 'center';
          cell.style.userSelect = 'none';
          cell.style.cursor = 'pointer';

          const ico = document.createElement('div');
          ico.style.width = '120px';
          ico.style.height = '120px';
          ico.style.margin = '0 auto';
          ico.style.backgroundColor = '#ccc';
          ico.style.border = '2px solid #000';
          ico.style.display = 'grid';
          ico.style.placeItems = 'center';
          ico.style.fontSize = '32px';
          ico.textContent = '?';

          const cap = document.createElement('div');
          cap.textContent = photoName;
          cap.style.marginTop = '8px';
          cap.style.fontSize = '12px';

          cell.addEventListener('click', () => {
            DesktopCore.spawnWindow({
              title: photoName,
              width: 400,
              height: 300,
              content: `<div style="font-family: var(--ui-font); font-size: 14px; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 20px;">⚠</div>
                <p><b>File corrupted or removed.</b></p>
              </div>`
            });
          });

          cell.appendChild(ico);
          cell.appendChild(cap);
          grid.appendChild(cell);
        });

        wrap.appendChild(grid);
        DesktopCore.spawnWindow({ title: 'Photos', width: 520, height: 420, content: wrap });
      }
    });

    /* МОДУЛЬ: Leave a Trace */
    (() => {
      function getTraceLines() {
        try {
          const saved = localStorage.getItem('narratoscope_trace');
          return saved ? JSON.parse(saved) : [];
        } catch(e) {
          return [];
        }
      }

      function saveTraceLines(lines) {
        try {
          localStorage.setItem('narratoscope_trace', JSON.stringify(lines));
        } catch(e) {}
      }

      DesktopCore.register({ id: 'leave-a-trace', title: 'Leave a Trace', iconClass: '', iconUrl: 'assets/icons/txt.png',
        onOpen() {
          let traceLines = getTraceLines();
          const wrap = document.createElement('div');
          wrap.style.fontFamily = 'var(--ui-font)';
          wrap.style.fontSize = '14px';

          const linesDiv = document.createElement('div');
          linesDiv.id = 'traceLines';
          linesDiv.style.border = '1px solid #000';
          linesDiv.style.padding = '12px';
          linesDiv.style.minHeight = '200px';
          linesDiv.style.background = '#fff';
          linesDiv.style.marginBottom = '16px';
          linesDiv.style.fontFamily = 'monospace';
          linesDiv.style.fontSize = '12px';
          linesDiv.style.whiteSpace = 'pre-wrap';
          linesDiv.textContent = traceLines.join('\n');

          wrap.innerHTML = `
            <p style="margin-bottom: 16px;"><b>Someone left this file open.</b></p>
            <p style="margin-bottom: 16px;">You can add one line.</p>
            <p style="margin-bottom: 20px;">Don't explain.<br>Don't sign your name.</p>
          `;
          wrap.appendChild(linesDiv);
          wrap.innerHTML += `
            <div style="margin-bottom: 8px;">
              <input type="text" id="traceInput" placeholder="Type your line here..." style="width: 100%; padding: 6px; border: 2px solid #000; font-family: var(--ui-font); font-size: 14px;">
  </div>
            <button id="traceSave" style="border: 2px solid #000; background: #fff; padding: 8px 16px; cursor: pointer; font-family: var(--ui-font); font-size: 14px; font-weight: 700;">Save</button>
            <div id="traceStatus" style="margin-top: 12px; font-size: 12px;"></div>
          `;

          DesktopCore.spawnWindow({ title: 'Leave a Trace', width: 560, height: 460, content: wrap });

          const input = wrap.querySelector('#traceInput');
          const saveBtn = wrap.querySelector('#traceSave');
          const status = wrap.querySelector('#traceStatus');
          const linesDivEl = wrap.querySelector('#traceLines');

          function updateLinesDisplay() {
            linesDivEl.textContent = traceLines.join('\n');
          }

          saveBtn.addEventListener('click', () => {
            const line = input.value.trim();
            if (line) {
              traceLines.push(line);
              input.value = '';
              updateLinesDisplay();
              saveTraceLines(traceLines);
              status.innerHTML = 'Line added.<br>It will be read by someone else.<br>Eventually.';
              status.style.color = '#000';
            }
          });

          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              saveBtn.click();
            }
          });
        }
      });
    })();

    // Порядок появления иконок (фиксированный)
const layout = [
      'my-computer',    // My Computer
      'drafts',         // Drafts
      'expenses',       // Expenses.xlsx
      'inbox',          // Inbox
      'photos',         // Photos
      'leave-a-trace'   // Leave a Trace
];
    // Фиксированная раскладка (проценты от рабочей области)
    const USE_FIXED_LAYOUT = true;
    const FIXED_POS = {
      'my-computer':    { xPct: 6,  yPct: 10 },
      'drafts':         { xPct: 24, yPct: 10 },
      'expenses':       { xPct: 42, yPct: 10 },
      'inbox':          { xPct: 6,  yPct: 35 },
      'photos':         { xPct: 24, yPct: 35 },
      'leave-a-trace':  { xPct: 42, yPct: 35 }
};

    function bootSequence() {
      const bootEl = document.getElementById('boot');
      bootEl.classList.remove('hidden');
      const bar = document.getElementById('bootbar'); 
      let p = 0; 
      const t = setInterval(() => { 
        p += Math.random()*18; 
        if (p >= 100) { 
          p = 100; 
          clearInterval(t); 
          bootEl.classList.add('hidden'); 
        } 
        bar.style.width = p + '%'; 
      }, 220);
    }

    // Применяем стартовый фон
    function applyInitialWallpaper(){
      WP_INDEX = 0;
      applyWallpaper();
    }

    function initDesktop() {
      const deskEl = document.querySelector('.desktop');
      const maxW = deskEl.clientWidth; const maxH = deskEl.clientHeight;
      const root = getComputedStyle(document.documentElement);
      const ICON = parseInt(root.getPropertyValue('--icon-size')) || 180;
      const PAD = 24; // внутренний отступ от краёв

      // helper: проценты → пиксели
      const pctToPx = (p) => ({
        x: Math.round((maxW - ICON) * (p.xPct/100)),
        y: Math.round((maxH - ICON) * (p.yPct/100))
      });

      const taken = [];
      const placeOne = () => {
        for (let tries = 0; tries < 200; tries++) {
          const x = Math.floor(Math.random() * (maxW - ICON - PAD*2)) + PAD;
          const y = Math.floor(Math.random() * (maxH - ICON - PAD*2)) + PAD;
          let ok = true;
          for (const t of taken) {
            if (Math.abs(x - t.x) < ICON * 0.9 && Math.abs(y - t.y) < ICON * 0.9) { ok = false; break; }
          }
          if (ok) return { x, y };
        }
        return { x: PAD + Math.random() * (maxW - ICON - PAD*2), y: PAD + Math.random() * (maxH - ICON - PAD*2) };
      };

      layout.forEach((id) => {
        const mod = DesktopCore.registry.get(id); if (!mod) return;
        const saved = DesktopCore.getIconPosition(id, null);
        const pos = saved || (USE_FIXED_LAYOUT && FIXED_POS[mod.id] ? pctToPx(FIXED_POS[mod.id]) : placeOne());
        taken.push(pos);
        DesktopCore.spawnIcon({ id: mod.id, title: mod.title, className: mod.iconClass, iconUrl: mod.iconUrl, x: pos.x, y: pos.y, onOpen: mod.onOpen, contextItems: mod.contextItems });
      });
    }

    /* ===== Password Screen ===== */
    const PASSWORD_WORDS = ['love', 'pretend', 'imagine'];
    const passwordScreen = document.getElementById('passwordScreen');
    const passwordInputs = ['pwd1', 'pwd2', 'pwd3'].map(id => document.getElementById(id));
    const passwordSubmit = document.getElementById('passwordSubmit');
    const passwordError = document.getElementById('passwordError');

    function checkPassword() {
      const values = passwordInputs.map(inp => inp.value.trim().toLowerCase());
      const correct = PASSWORD_WORDS.every((word, i) => values[i] === word);
      if (correct) {
        passwordScreen.classList.add('hidden');
        bootSequence();
        setTimeout(() => { initDesktop(); applyInitialWallpaper(); }, 100);
      } else {
        passwordError.textContent = 'Incorrect password. Please try again.';
        passwordInputs.forEach(inp => { inp.value = ''; inp.style.borderColor = '#9b0000'; });
        setTimeout(() => {
          passwordInputs.forEach(inp => { inp.style.borderColor = '#000'; });
          passwordError.textContent = '';
        }, 2000);
        passwordInputs[0].focus();
      }
    }

    passwordSubmit.addEventListener('click', checkPassword);
    passwordInputs.forEach((inp, i) => {
      inp.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (i < passwordInputs.length - 1) passwordInputs[i + 1].focus();
          else checkPassword();
        }
      });
    });
    passwordInputs[0].focus();
  </script>




